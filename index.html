<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Jar Decompiler | ÂÖçË¥πÂú®Á∫øJava CFRÂèçÁºñËØëÂô®</title>
    <meta name="description" content="ÂÖçË¥πÂú®Á∫øJava CFRÂèçÁºñËØëÂô® | Free Online Java CFR Decompiler. ‰∏ÄÈîÆÂ∞Ü.class/.jarÊñá‰ª∂ÂèçÁºñËØë‰∏∫ÂèØËØªJavaÊ∫êÁ†Å | Instantly decompile .class/.jar files to readable Java source code. Êó†ÈúÄÂÆâË£ÖÔºåÂÆåÂÖ®Âú®ÊµèËßàÂô®‰∏≠ËøêË°å | No installation required, runs entirely in your browser.">
    <meta name="keywords" content="
        JavaÂèçÁºñËØë, Java decompiler, 
        Âú®Á∫øÂèçÁºñËØëÂô®, online java decompiler, 
        CFRÂèçÁºñËØë, CFR decompiler, 
        .classÂèçÁºñËØë, decompile class file, 
        .jarÂèçÁºñËØë, decompile jar, 
        JavaÂ≠óËäÇÁ†ÅËΩ¨Ê∫êÁ†Å, java bytecode to source, 
        Java Decompiler Online, Âú®Á∫øJavaÂèçÁºñËØëÂ∑•ÂÖ∑,
        Êü•ÁúãJavaÁ±ªÊ∫êÁ†Å, view java class source, 
        ÂèçÁºñËØëÂ∑•ÂÖ∑, decompilation tool, 
        ‰ª£Á†ÅÊÅ¢Â§ç, code recovery, 
        JavaÈÄÜÂêë, java reverse engineering, 
        Êó†Ê∫êÁ†ÅË∞ÉËØï, debug without source code, 
        ÂàÜÊûêJarÂåÖ, analyze jar file, 
        Java CFRÂ∑•ÂÖ∑, Java CFR tool, 
        ÂÖçË¥πÂèçÁºñËØë, free decompiler,
        Â≠óËäÇÁ†ÅÂèçÁºñËØë, bytecode decompiler,
        JavaÁ±ªÊü•ÁúãÂô®, java class viewer,
        Âú®Á∫ø‰ª£Á†ÅÂàÜÊûê, online code analysis
    ">
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>

    <style>
        :root {
            --bg-color: #282c34;
            --ui-bg: #3c3f41;
            --panel-bg: #2b2b2b;
            --tab-bg: #313335;
            --tab-active: #282c34;
            --text-color: #bbbbbb;
            --text-bright: #e6e6e6;
            --accent: #4b6eaf;
            --border: #555555;
            --line-num-color: #606366;
            --font-ui: "Segoe UI", Tahoma, sans-serif;
            --font-code: "JetBrains Mono", "Consolas", monospace;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--ui-bg); color: var(--text-color);
            font-family: var(--font-ui);
            height: 100vh; 
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--ui-bg); }
        ::-webkit-scrollbar-thumb { background: #555; border: 2px solid var(--ui-bg);  }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        ::-webkit-scrollbar-corner { background: var(--ui-bg); }

        /* --- Layout --- */
        header {
            padding: 0 15px; height: 45px; flex-shrink: 0;
            background-color: var(--ui-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #container {
            display: flex; 
            flex: 1; 
            min-height: 0; 
        }
        

        #main-panel {
            flex: 1; display: flex; flex-direction: column; 
            overflow: hidden; background-color: var(--bg-color);
        }
        #tab-bar::-webkit-scrollbar { 
            display: none; 
        }
        /* --- Tabs --- */
        #tab-bar {
            height: 35px; 
            background-color: var(--ui-bg);
            
            display: flex; 
            align-items: flex-end;
            
            padding-left: 0; 
            
            overflow-x: auto; 
            overflow-y: hidden;
            
            border-bottom: 1px solid var(--border);
            
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        .tab {
            height: 30px; 
            padding: 0 10px; 
            
            flex-shrink: 0; 
            
            min-width: 100px; 
            max-width: 200px;
            
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            
            background-color: var(--tab-bg);
            color: #888;
            font-size: 12px;
            
            border-right: 1px solid #222; 
            border-top: 2px solid transparent;
            
            cursor: pointer;
            user-select: none;
        }

        .tab:hover { background-color: #3a3d3f; }

        .tab.active {
            background-color: var(--tab-active);
            color: var(--text-bright);
            border-top: 2px solid var(--accent); 
        }

        .tab-close { 
            width: 16px; height: 16px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; opacity: 0; transition: 0.2s; 
            margin-left: 8px;
        }
        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background-color: #cc5555; color: white; }

        #editors-stack { flex: 1; position: relative; overflow: hidden; }
        .editor-instance { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: auto; display: none; }
        .editor-instance.active { display: block; }
        
        pre {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100%;
            min-width: 100%;
            width: fit-content; 
            padding-bottom: 20px;
        }
        
        code.hljs {
            font-family: var(--font-code); 
            font-size: 13px; 
            line-height: 1.5; 
            background: transparent;
            padding: 0 !important;
            
            min-width: 100%;
        }

        table.hljs-ln {
            width: auto;
            min-width: 100%; 
            border-collapse: collapse;
        }

        .hljs-ln-numbers {
            width: 1%;
            min-width: 35px;
            white-space: nowrap;
            text-align: right;
            color: var(--line-num-color);
            border-right: 1px solid var(--border);
            vertical-align: top;
            padding: 0px 10px 0px 5px !important;
            user-select: none;
            
            position: sticky;
            left: 0; 
            z-index: 10;
            background-color: var(--bg-color);
        }

        .hljs-ln-code {
            padding: 0px 10px 0px 15px !important;
            vertical-align: top;
            white-space: pre; 
        }



        .drag-active {
            background-color: #3a3d3f !important;
            border: 2px dashed #4b6eaf;
            opacity: 0.8;
        }
        /* --- Tree UI --- */
        .tree-item { cursor: pointer; padding: 3px 10px;  align-items: center; color: var(--text-color); white-space: nowrap; }
        .tree-item:hover { background-color: #2b2b2b; }
        .tree-item.selected { background-color: #0d293e; color: white; border-left: 3px solid var(--accent); }
        .folder-children { display: none; padding-left: 18px; }
        .folder-open > .folder-children { display: block; }
        .arrow { display: inline-block; width: 12px; font-size: 10px; transition: transform 0.1s; }
        .folder-open > .tree-item > .arrow { transform: rotate(90deg); }

        /* --- Misc --- */
        .btn { background-color: #4c5052; color: white; border: 1px solid #5f6161; padding: 8px 16px; cursor: pointer; font-size: 12px; }
        .btn:hover { background-color: #5f6161; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(40, 44, 52, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 14px; color: white; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-window { background: var(--ui-bg); width: 600px; height: 80vh; border: 1px solid #666; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; border-radius: 4px; }
        .modal-header { padding: 10px 15px; background: #333; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .modal-body { flex: 1; overflow-y: auto; padding: 10px; background: #2b2b2b; }
        .modal-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #333; }
        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #3a3a3a; }
        .opt-name { color: #cc7832; font-size: 12px; display: block; font-family: var(--font-code); }
        .opt-desc { color: #888; font-size: 11px; margin-top: 2px; display: block;}
        input[type="checkbox"] { accent-color: var(--accent); transform: scale(1.1); }
        select { background: #454545; color: white; border: 1px solid #666; }
        .search-bar {  padding: 8px; background: #2b2b2b; border: none; border-bottom: 1px solid var(--border); color: white; outline: none; }
        
        /* About Modal Specific Styles */
        .lib-list { list-style: none; padding: 0; margin: 0; }
        .lib-item { 
            padding: 10px; border-bottom: 1px solid #3a3a3a; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .lib-item:last-child { border-bottom: none; }
        .lib-name { color: #e6e6e6; font-weight: bold; }
        .lib-desc { color: #888; font-size: 12px; margin-left: 10px; }
        .lib-link { color: var(--accent); text-decoration: none; font-size: 12px; }
        .lib-link:hover { text-decoration: underline; }
        
        /* Sidebar Layout Changes */
        #sidebar {
            width: 240px; 
            flex-shrink: 0;
            background-color: #313335; border-right: 1px solid var(--border);
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--border);
            height: 100%; 
            overflow: hidden;
            padding: 0;
        }

        .sidebar-search {
            
            padding: 8px;
            border-bottom: 1px solid var(--border);
            background-color: var(--ui-bg);
            flex-shrink: 0;
        }

        #tree-search {
            width: 100%; box-sizing: border-box;
            background-color: #2b2b2b; color: #ddd;
            border: 1px solid #555; padding: 5px;
            font-size: 12px;
            font-family: var(--font-ui);
            outline: none;
        }
        #tree-search:focus { border-color: var(--accent); }

        #tree-content {
            flex: 1;
            min-height: 0;
            overflow: auto;
            padding: 5px 0;
            position: relative;
        }

        /* --- Header Layout (Fixed Left Alignment) --- */
        header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            
            align-items: stretch; 
            
            padding: 10px 15px; 
            height: auto; 
            background-color: var(--ui-bg);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            flex-shrink: 0;
            gap: 8px;
        }

        .header-row-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-row-bottom {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
        }

        #bottom-bar {
            height: 25px; 
            background-color: var(--ui-bg);
            border-top: 1px solid var(--border);
            
            display: flex;
            align-items: center;
            justify-content: space-between;
            
            padding: 0 10px;
            font-size: 11px;
            color: #888;
            
            flex-shrink: 0;
            z-index: 10;
            user-select: none;
        }

        .context-menu {
            display: none;
            position: fixed;
            z-index: 2000;
            background: #3c3f41;
            border: 1px solid #555;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            min-width: 160px;
            padding: 5px 0;
            border-radius: 3px;
            font-family: var(--font-ui);
        }

        .menu-item {
            padding: 6px 15px;
            cursor: pointer;
            font-size: 12px;
            color: #bbb;
            transition: background 0.1s;
        }

        .menu-item:hover {
            background-color: #4b6eaf;
            color: white;
        }

        .menu-item-separator {
            height: 1px;
            background-color: #555;
            margin: 4px 0;
        }


        #sidebar-toggle {
            cursor: pointer;
            font-size: 14px;
            opacity: 0.7;
            transition: all 0.2s;
            user-select: none; 
        }

        #sidebar-toggle:hover {
            opacity: 1;
            text-shadow: 0 0 5px rgba(255,255,255,0.3); 
        }

        #sidebar-toggle.closed {
            opacity: 0.4;
            filter: grayscale(100%);
        }

    </style>
</head>
<body>

    <header>
        <div class="header-row-top">
            <h3 style="margin: 0; color: #e6e6e6; font-size: 16px;">
                WJD - 
                <span id="status-bar" style="font-size: 12px; color: #888;">Ready</span>
            </h3>
        </div>

        <div class="header-row-bottom">
            <button class="btn" onclick="document.getElementById('file-input').click()">Open JAR</button>
            <button class="btn" onclick="openOptions()">Options</button>
            <button class="btn" onclick="openAbout()">About</button>
        </div>

        <input accept=".jar,.zip,.war" id="file-input" type="file" style="display: none;">
    </header>

    <div id="container">
        <div id="sidebar">
            <div id="tree-content">
                <div style="padding:20px; text-align:center; color:#666;">Drop me a jar</div>
            </div>
            <div class="sidebar-search">
                <input type="text" id="tree-search" placeholder="Filter..." autocomplete="off">
            </div>
        </div>
        
        <div id="main-panel">
            <div id="tab-bar"></div>
            <div id="editors-stack">
                <div id="empty-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; text-align: center;">
                    <h3>Web Jar Decompiler</h3>
                    <p>Select a file to view content</p>
                </div>
            </div>
            <div id="bottom-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">üóÇÔ∏è</span>
                    <span style="border-right: 1px solid #555; height: 14px;"></span>
                    <span id="status-bar">Ready</span>
                </div>
                <div style="display:flex; gap:15px;">
                    <span>CFR</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Options Modal -->
    <div id="options-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span>CFR Options</span><span style="cursor:pointer" onclick="closeOptions()">‚úï</span>
            </div>
            <input type="text" id="opt-search" class="search-bar" placeholder="Filter options..." onkeyup="filterOptions()">
            <div class="modal-body" id="options-list"></div>
            <div class="modal-footer">
                <button class="btn" onclick="closeOptions()">Cancel</button>
                <button class="btn" style="background-color: var(--accent);" onclick="saveOptions()">Save & Reload</button>
            </div>
        </div>
    </div>
    
    <!-- about modal -->
    <div id="about-modal" class="modal-overlay">
        <div class="modal-window" style="height: auto; max-height: 80vh;">
            <div class="modal-header">
                <span>About</span><span style="cursor:pointer" onclick="closeAbout()">‚úï</span>
            </div>
            <div class="modal-body">
                <div style="padding: 15px; text-align: center; border-bottom: 1px solid #3a3a3a;">
                    <h3 style="margin: 0 0 10px 0; color: #e6e6e6;">Web Jar Decompiler</h3>
                    <p style="margin: 0; color: #888; font-size: 13px;">
                        A web-based Java decompiler running entirely in your browser.<br>
                        Inspired by Recaf, powered by WebAssembly.
                    </p>
                </div>
                <ul class="lib-list">
                    <li class="lib-item">
                        <div>
                            <span class="lib-name">CFR Decompiler</span>
                            <span class="lib-desc">The core decompilation engine (WASM)</span>
                        </div>
                        <a href="https://github.com/katana-project/cfr" target="_blank" class="lib-link">Website</a>
                    </li>
                    <li class="lib-item">
                        <div>
                            <span class="lib-name">JSZip</span>
                            <span class="lib-desc">Reading .jar and .zip archives</span>
                        </div>
                        <a href="https://stuk.github.io/jszip/" target="_blank" class="lib-link">Website</a>
                    </li>
                    <li class="lib-item">
                        <div>
                            <span class="lib-name">Highlight.js</span>
                            <span class="lib-desc">Syntax highlighting</span>
                        </div>
                        <a href="https://highlightjs.org/" target="_blank" class="lib-link">Website</a>
                    </li>
                    <li class="lib-item">
                        <div>
                            <span class="lib-name">Highlightjs-line-numbers</span>
                            <span class="lib-desc">Line number plugin</span>
                        </div>
                        <a href="https://github.com/wcoder/highlightjs-line-numbers.js" target="_blank" class="lib-link">Website</a>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAbout()">Close</button>
            </div>
        </div>
    </div>

    <div id="tab-ctx-menu" class="context-menu">
        <div class="menu-item" id="ctx-close">Close</div>
        <div class="menu-item" id="ctx-close-others">Close Others</div>
        <div class="menu-item-separator"></div>
        <div class="menu-item" id="ctx-close-right">Close to the Right</div>
        <div class="menu-item" id="ctx-close-left">Close to the Left</div>
        <div class="menu-item" id="ctx-close-all">Close All</div>
    </div>

    <script type="module">
        
        // --- GLOBAL STATE ---
        let currentZip = null;
        let openTabs = new Map();
        let activePath = null;
        let decompilerWorker = null; 
        let pendingResolves = new Map();

        function initWorker() {
            const workerScript = `
                import { decompile } from "https://cdn.jsdelivr.net/npm/@run-slicer/cfr/cfr.js";

                self.onmessage = async (e) => {
                    const { msgId, action, payload } = e.data;

                    if (action === 'decompile') {
                        const { className, options } = payload;
                        
                        try {
                            const result = await decompile(className, {
                                source: async (requestPath) => {
                                    const requestId = Math.random().toString(36);
                                    
                                    self.postMessage({ 
                                        type: 'request_file', 
                                        requestId: requestId, 
                                        path: requestPath 
                                    });

                                    return new Promise((resolve) => {
                                        const handler = (evt) => {
                                            if (evt.data.type === 'response_file' && evt.data.requestId === requestId) {
                                                self.removeEventListener('message', handler);
                                                resolve(evt.data.content);
                                            }
                                        };
                                        self.addEventListener('message', handler);
                                    });
                                },
                                options: options
                            });

                            self.postMessage({ type: 'finish', msgId, success: true, content: result });
                        } catch (err) {
                            self.postMessage({ type: 'finish', msgId, success: false, error: err.toString() });
                        }
                    }
                };
            `;

            const blob = new Blob([workerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            decompilerWorker = new Worker(workerUrl, { type: 'module' });

            decompilerWorker.onmessage = async (e) => {
                const data = e.data;

                if (data.type === 'request_file') {
                    const { requestId, path } = data;
                    let content = null;
                    
                    let cleanPath = path;
                    if (cleanPath.indexOf('.') !== -1 && cleanPath.indexOf('/') === -1) cleanPath = cleanPath.replace(/\./g, '/');
                    if (!cleanPath.endsWith(".class")) cleanPath += ".class";
                    if (cleanPath.startsWith("/")) cleanPath = cleanPath.substring(1);

                    if (currentZip) {
                        const f = currentZip.file(cleanPath);
                        if (f) {
                            content = await f.async("uint8array");
                        }
                    }
                    
                    decompilerWorker.postMessage({ 
                        type: 'response_file', 
                        requestId, 
                        content 
                    }, content ? [content.buffer] : []);
                }
                
                else if (data.type === 'finish') {
                    const resolver = pendingResolves.get(data.msgId);
                    if (resolver) {
                        if (data.success) resolver.resolve(data.content);
                        else resolver.reject(new Error(data.error));
                        pendingResolves.delete(data.msgId);
                    }
                }
            };
        }

        initWorker();

        const tabBarEl = document.getElementById("tab-bar");
    
        tabBarEl.addEventListener("wheel", (e) => {
            if (e.deltaY !== 0) {
                e.preventDefault();
                tabBarEl.scrollLeft += e.deltaY;
            }
        }, { passive: false });

        window.toggleSidebar = () => {
            const sb = document.getElementById("sidebar");
            const btn = document.getElementById("sidebar-toggle");
            
            const isHidden = window.getComputedStyle(sb).display === "none";
            
            if (isHidden) {
                sb.style.display = "flex";
                btn.classList.remove("closed");
            } else {
                sb.style.display = "none";
                btn.classList.add("closed");
            }
        };

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- CONFIGURATION ---
        const CFR_DEFAULTS = [
            { k: "stringbuffer", d: "Sugar StringBuffer", t: "bool", v: "false" },
            { k: "stringbuilder", d: "Sugar StringBuilder", t: "bool", v: "true" },
            { k: "stringconcat", d: "Sugar StringConcatFactory", t: "bool", v: "true" },
            { k: "decodeenumswitch", d: "Resugar Enum Switch", t: "bool", v: "true" },
            { k: "sugarenums", d: "Resugar Enums", t: "bool", v: "true" },
            { k: "decodestringswitch", d: "Resugar String Switch", t: "bool", v: "true" },
            { k: "previewfeatures", d: "Preview Features", t: "bool", v: "true" },
            { k: "sealed", d: "Sealed Classes", t: "bool", v: "true" },
            { k: "switchexpression", d: "Switch Expression", t: "bool", v: "true" },
            { k: "recordtypes", d: "Record Types", t: "bool", v: "true" },
            { k: "instanceofpattern", d: "Instanceof Pattern", t: "bool", v: "true" },
            { k: "arrayiter", d: "Array Iteration", t: "bool", v: "true" },
            { k: "collectioniter", d: "Collection Iteration", t: "bool", v: "true" },
            { k: "tryresources", d: "Try-With-Resources", t: "bool", v: "true" },
            { k: "decodelambdas", d: "Decode Lambdas", t: "bool", v: "true" },
            { k: "innerclasses", d: "Inner Classes", t: "bool", v: "true" },
            { k: "forbidmethodscopedclasses", d: "Forbid Method Scoped", t: "bool", v: "false" },
            { k: "forbidanonymousclasses", d: "Forbid Anonymous", t: "bool", v: "false" },
            { k: "skipbatchinnerclasses", d: "Skip Batch Inner", t: "bool", v: "true" },
            { k: "hideutf", d: "Hide UTF8", t: "bool", v: "true" },
            { k: "hidelongstrings", d: "Hide Long Strings", t: "bool", v: "false" },
            { k: "removeboilerplate", d: "Remove Boilerplate", t: "bool", v: "true" },
            { k: "removeinnerclasssynthetics", d: "Remove Inner Synthetics", t: "bool", v: "true" },
            { k: "relinkconst", d: "Relink Constants", t: "bool", v: "true" },
            { k: "liftconstructorinit", d: "Lift Constructor Init", t: "bool", v: "true" },
            { k: "removedeadmethods", d: "Remove Dead Methods", t: "bool", v: "true" },
            { k: "removebadgenerics", d: "Remove Bad Generics", t: "bool", v: "true" },
            { k: "sugarasserts", d: "Sugar Asserts", t: "bool", v: "true" },
            { k: "sugarboxing", d: "Sugar Boxing", t: "bool", v: "true" },
            { k: "sugarretrolambda", d: "Sugar Retro Lambda", t: "bool", v: "false" },
            { k: "showversion", d: "Show CFR Version", t: "bool", v: "false" },
            { k: "decodefinally", d: "Decode Finally", t: "bool", v: "true" },
            { k: "tidymonitors", d: "Tidy Monitors", t: "bool", v: "true" },
            { k: "commentmonitors", d: "Comment Monitors", t: "bool", v: "false" },
            { k: "lenient", d: "Lenient Mode", t: "bool", v: "true" },
            { k: "dumpclasspath", d: "Dump Classpath", t: "bool", v: "false" },
            { k: "comments", d: "Decompiler Comments", t: "bool", v: "false" },
            { k: "ignoreexceptionsalways", d: "Ignore Exceptions Always", t: "bool", v: "false" },
            { k: "antiobf", d: "Anti Obfuscation", t: "bool", v: "false" },
            { k: "obfcontrol", d: "Obfuscated Control Flow", t: "bool", v: "false" },
            { k: "obfattr", d: "Obfuscated Attributes", t: "bool", v: "false" },
            { k: "constobf", d: "Obfuscated Constants", t: "bool", v: "false" },
            { k: "hidebridgemethods", d: "Hide Bridge Methods", t: "bool", v: "true" },
            { k: "ignoreexceptions", d: "Ignore Exceptions", t: "bool", v: "false" },
            { k: "silent", d: "Silent", t: "bool", v: "false" },
            { k: "recover", d: "Recover", t: "bool", v: "true" },
            { k: "eclipse", d: "Eclipse Compat", t: "bool", v: "true" },
            { k: "override", d: "Generate @Override", t: "bool", v: "true" },
            { k: "showinferrable", d: "Show Inferrable Types", t: "bool", v: "false" },
            { k: "allowcorrecting", d: "Allow Correcting", t: "bool", v: "true" },
            { k: "labelledblocks", d: "Labelled Blocks", t: "bool", v: "true" },
            { k: "j14classobj", d: "Java 1.4 Class Objects", t: "bool", v: "false" },
            { k: "hidelangimports", d: "Hide java.lang Imports", t: "bool", v: "false" },
            { k: "staticinitreturn", d: "Static Init Return", t: "bool", v: "true" },
            { k: "usenametable", d: "Use Name Table", t: "bool", v: "true" },
            { k: "pullcodecase", d: "Pull Code Case", t: "bool", v: "false" },
            { k: "elidescala", d: "Elide Scala", t: "bool", v: "false" },
            { k: "usesignatures", d: "Use Signatures", t: "bool", v: "true" },
            { k: "caseinsensitivefs", d: "Case Insensitive FS", t: "bool", v: "false" },
            { k: "lomem", d: "Low Mem", t: "bool", v: "false" },
            { k: "trackbytecodeloc", d: "Track Bytecode Loc", t: "bool", v: "false" },
            { k: "dumpexceptionstacktrace", d: "Dump Exception Stack", t: "bool", v: "true" },

            { k: "forcetopsort", d: "Force Topsort", t: "troolean", v: "neither" },
            { k: "forloopaggcapture", d: "For Loop Agg Capture", t: "troolean", v: "neither" },
            { k: "forcetopsortaggress", d: "Force Topsort Aggress", t: "troolean", v: "neither" },
            { k: "forcetopsortnopull", d: "Force Topsort NoPull", t: "troolean", v: "neither" },
            { k: "forcecondpropagate", d: "Force Cond Propagate", t: "troolean", v: "neither" },
            { k: "reducecondscope", d: "Reduce Cond Scope", t: "troolean", v: "neither" },
            { k: "forcereturningifs", d: "Force Returning Ifs", t: "troolean", v: "neither" },
            { k: "forceexceptionprune", d: "Force Exception Prune", t: "troolean", v: "neither" },
            { k: "aexagg", d: "Aggressive Ex Agg", t: "troolean", v: "neither" },
            { k: "aexagg2", d: "Aggressive Ex Agg 2", t: "troolean", v: "neither" },
            { k: "recovertypeclash", d: "Recover Type Clash", t: "troolean", v: "neither" },
            { k: "recovertypehints", d: "Recover Type Hints", t: "troolean", v: "neither" },
            { k: "removedeadconditionals", d: "Remove Dead Conditionals", t: "troolean", v: "neither" },
            { k: "aggressivedoextension", d: "Aggressive Do Ext", t: "troolean", v: "neither" },
            { k: "aggressiveduff", d: "Aggressive Duff", t: "troolean", v: "neither" },
            { k: "allowmalformedswitch", d: "Allow Malformed Switch", t: "troolean", v: "neither" },
            { k: "clobber", d: "Clobber Files", t: "troolean", v: "neither" },
            
            { k: "decompiletimeout", d: "[Web] Timeout (ms)", t: "int", v: "15000" }
        ];

        let currentOptions = {};
        CFR_DEFAULTS.forEach(o => currentOptions[o.k] = o.v);

        // --- FILE LOADING ---
        const input = document.getElementById("file-input");
        const sidebar = document.getElementById("sidebar");
        const treeContent = document.getElementById("tree-content");
        const status = document.getElementById("status-bar");

        async function loadJarFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.jar') && !file.name.endsWith('.zip') && !file.name.endsWith('.war')) {
                alert("Please drop a valid .jar, .zip, or .war file.");
                return;
            }

            status.textContent = "Loading " + file.name + "...";
            try {
                const arrayBuffer = await file.arrayBuffer();
                currentZip = await JSZip.loadAsync(arrayBuffer);
                renderTree(currentZip.files);
                status.textContent = file.name;
            } catch (err) {
                console.error(err);
                alert("Failed to load JAR: " + err.message);
                status.textContent = "Error loading file";
            }
        }

        treeContent.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            treeContent.classList.add('drag-active');
        });

        treeContent.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            treeContent.classList.remove('drag-active');
        });

        treeContent.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            treeContent.classList.remove('drag-active');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                loadJarFile(file);
            }
        });

        input.addEventListener("change", (e) => {
            loadJarFile(e.target.files[0]);
        });

        // --- TREE VIEW ---
        function renderTree(files) {
            const treeContainer = document.getElementById("tree-content");
            treeContainer.innerHTML = "";
            
            const searchInput = document.getElementById("tree-search");
            searchInput.value = "";
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            newSearchInput.addEventListener('input', debounce(filterTree, 300));

            const root = {};
            Object.keys(files).forEach(path => {
                const parts = path.split('/');
                let current = root;
                parts.forEach((part, index) => {
                    if (!part) return;
                    if (!current[part]) current[part] = { __name: part, __path: path, __isDir: index < parts.length - 1 || files[path].dir };
                    if (index === parts.length - 1 && !files[path].dir) current[part].__file = files[path];
                    current = current[part];
                });
            });
            
            const ul = document.createElement('div');
            buildDom(root, ul);
            treeContainer.appendChild(ul);
        }

        function filterTree() {
            const input = document.getElementById('tree-search');
            const filter = input.value.toLowerCase();
            const root = document.getElementById('tree-content');
            const allWrappers = root.querySelectorAll('.file-wrapper, .folder-wrapper');
            
            if (!filter) {
                allWrappers.forEach(el => el.style.display = "");
                return;
            }
            allWrappers.forEach(el => el.style.display = "none");
            const items = root.querySelectorAll('.tree-item');
            items.forEach(item => {
                if (item.innerText.toLowerCase().includes(filter)) {
                    let currentWrapper = item.closest('.file-wrapper, .folder-wrapper');
                    if (currentWrapper) currentWrapper.style.display = "block";
                    let parent = currentWrapper.parentElement;
                    while(parent && parent !== root) {
                        if (parent.classList.contains('folder-children')) {
                            const folderWrapper = parent.closest('.folder-wrapper');
                            if (folderWrapper) {
                                folderWrapper.style.display = "block";
                                folderWrapper.classList.add('folder-open');
                            }
                        }
                        parent = parent.parentElement;
                    }
                }
            });
        }

        function buildDom(node, container) {
            const keys = Object.keys(node).filter(k => !k.startsWith('__')).sort((a, b) => {
                const aDir = node[a].__isDir; 
                const bDir = node[b].__isDir;
                if (aDir === bDir) return a.localeCompare(b);
                return aDir ? -1 : 1;
            });

            keys.forEach(key => {
                const item = node[key];
                const isDir = item.__isDir;
                const wrapper = document.createElement('div');
                wrapper.className = isDir ? 'folder-wrapper' : 'file-wrapper';
                const row = document.createElement('div');
                row.className = 'tree-item ' + (isDir ? 'tree-folder' : 'tree-file');
                
                const arrow = isDir ? '<span class="arrow">‚ñ∂</span>' : '<span style="width:12px;display:inline-block"></span>';
                let icon = isDir ? 'üìÅ' : (key.endsWith('.class') ? '‚òï' : 'üìÑ');
                
                row.innerHTML = `${arrow}<span style="margin-right:5px">${icon}</span> ${key}`;
                wrapper.appendChild(row);

                if (isDir) {
                    const children = document.createElement('div');
                    children.className = 'folder-children';
                    buildDom(item, children);
                    wrapper.appendChild(children);
                    row.addEventListener('click', (e) => {
                        e.stopPropagation(); wrapper.classList.toggle('folder-open');
                    });
                } else {
                    row.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
                        row.classList.add('selected');
                        openTab(item.__path, item.__file);
                    });
                }
                container.appendChild(wrapper);
            });
        }

        // --- TAB SYSTEM ---
        function openTab(filePath, zipEntry) {
            if (openTabs.has(filePath)) {
                activateTab(filePath);
                return;
            }

            const fileName = filePath.split('/').pop();
            const tabEl = document.createElement("div");
            tabEl.className = "tab";
            tabEl.innerHTML = `
                <div style="display:flex;align-items:center">
                    <span style="margin-right:5px">${fileName.endsWith('.class') ? '' : ''}</span>
                    <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px" title="${filePath}">${fileName}</span>
                </div>
                <div class="tab-close">‚úï</div>
            `;
            
            tabEl.onclick = () => activateTab(filePath);
            tabEl.querySelector(".tab-close").onclick = (e) => {
                e.stopPropagation(); 
                closeTab(filePath);
            };

            tabEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, filePath);
            });

            document.getElementById("tab-bar").appendChild(tabEl);
            
            const wrapper = document.createElement("div");
            wrapper.className = "editor-instance";

            const pre = document.createElement("pre");
            const code = document.createElement("code");
            
            let lang = 'plaintext';
            if (fileName.endsWith('.class')) lang = 'java';
            else if (fileName.endsWith('.xml')) lang = 'xml';
            else if (fileName.endsWith('.json')) lang = 'json';
            else if (fileName.endsWith('.js')) lang = 'javascript';
            
            code.className = `language-${lang}`; 
            pre.appendChild(code);
            wrapper.appendChild(pre);
            
            const loading = document.createElement("div");
            loading.className = "loading-overlay";
            loading.textContent = "Queued...";
            wrapper.appendChild(loading);
            
            document.getElementById("editors-stack").appendChild(wrapper);

            openTabs.set(filePath, { tabEl, editorEl: wrapper, loadingEl: loading, codeEl: code, path: filePath });

            activateTab(filePath);
            loadContent(filePath, zipEntry, code, loading);
        }

        function activateTab(path) {
            if (!openTabs.has(path)) {
                console.warn("Attempted to activate non-existent tab:", path);
                return;
            }

            if (activePath && openTabs.has(activePath)) {
                const curr = openTabs.get(activePath);
                if (curr) {
                    curr.tabEl.classList.remove("active");
                    curr.editorEl.classList.remove("active");
                }
            }

            activePath = path;
            const target = openTabs.get(path);
            
            if (target) {
                target.tabEl.classList.add("active");
                target.editorEl.classList.add("active");
                document.getElementById("empty-state").style.display = "none";
            }
        }

        function closeTab(path) {
            const target = openTabs.get(path);
            if (!target) return;

            target.tabEl.remove();
            target.editorEl.remove();
            openTabs.delete(path);

            if (activePath === path) {
                activePath = null;
                
                const keys = Array.from(openTabs.keys());
                if (keys.length > 0) {
                    activateTab(keys[keys.length - 1]);
                } else {
                    document.getElementById("empty-state").style.display = "block";
                }
            }
        }

        // --- CONTENT LOADING (Web Worker Proxy) ---
        async function loadContent(path, zipEntry, codeEl, loadingEl) {
            try {
                loadingEl.style.display = "flex";
                loadingEl.textContent = "Decompiling...";
                
                let content = "";
                if (path.endsWith(".class")) {
                    const className = path.replace(/\.class$/, "");
                    const timeoutMs = parseInt(currentOptions["decompiletimeout"]) || 15000;
                    
                    const realCfrOptions = { ...currentOptions };
                    delete realCfrOptions["decompiletimeout"];

                    const msgId = Math.random().toString(36);
                    
                    const workerPromise = new Promise((resolve, reject) => {
                        pendingResolves.set(msgId, { resolve, reject });
                        decompilerWorker.postMessage({
                            msgId,
                            action: 'decompile',
                            payload: { className, options: realCfrOptions }
                        });
                    });

                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            if (pendingResolves.has(msgId)) {
                                pendingResolves.delete(msgId);
                                reject(new Error(`Timed out after ${timeoutMs}ms`));
                            }
                        }, timeoutMs);
                    });

                    content = await Promise.race([workerPromise, timeoutPromise]);

                } else {
                    content = await zipEntry.async("string");
                    if (content.length > 500000) content = content.substring(0, 500000) + "\n... Truncated";
                }
                
                codeEl.textContent = content;
                codeEl.removeAttribute('data-highlighted');
                hljs.highlightElement(codeEl);
                if (codeEl.parentElement.querySelectorAll('.hljs-ln').length === 0) {
                    hljs.lineNumbersBlock(codeEl);
                }
            } catch (e) {
                console.error("Worker Error:", e);
                codeEl.textContent = "// Error: " + e.message;
                if (e.message.includes("Timed out")) {
                    codeEl.textContent += `\n\n// Tip: Increase [Web] Timeout in Options`;
                }
            } finally {
                loadingEl.style.display = "none";
            }
        }

        // --- OPTIONS ---
        window.openOptions = () => {
            const list = document.getElementById("options-list");
            list.innerHTML = "";
            CFR_DEFAULTS.forEach(opt => {
                const div = document.createElement("div");
                div.className = "opt-row";
                div.dataset.key = opt.k;
                const val = currentOptions[opt.k];
                let inputHtml = "";
                
                if (opt.t === 'bool') {
                    inputHtml = `<input type="checkbox" id="opt-${opt.k}" ${val === "true" ? 'checked' : ''}>`;
                } else if (opt.t === 'troolean') {
                    inputHtml = `
                        <select id="opt-${opt.k}">
                            <option value="true" ${val === 'true' ? 'selected' : ''}>True</option>
                            <option value="false" ${val === 'false' ? 'selected' : ''}>False</option>
                            <option value="neither" ${val === 'neither' ? 'selected' : ''}>Neither</option>
                        </select>
                    `;
                } else if (opt.t === 'int') {
                    inputHtml = `<input type="number" id="opt-${opt.k}" value="${val}" style="width:70px">`;
                }
                div.innerHTML = `<div><span class="opt-name">${opt.k}</span><span class="opt-desc">${opt.d}</span></div><div>${inputHtml}</div>`;
                list.appendChild(div);
            });
            document.getElementById("options-modal").style.display = "flex";
            document.getElementById("opt-search").focus();
        };

        window.closeOptions = () => document.getElementById("options-modal").style.display = "none";
        
        window.saveOptions = () => {
            CFR_DEFAULTS.forEach(opt => {
                const el = document.getElementById("opt-" + opt.k);
                if (el) {
                    if (opt.t === 'bool') currentOptions[opt.k] = el.checked ? "true" : "false";
                    else currentOptions[opt.k] = el.value.toString();
                }
            });
            closeOptions();
            if (activePath && activePath.endsWith(".class")) {
                const t = openTabs.get(activePath);
                t.loadingEl.style.display = "flex";
                const entry = currentZip.file(activePath);
                loadContent(activePath, entry, t.codeEl, t.loadingEl);
            }
        };
        
        window.filterOptions = () => {
            const filter = document.getElementById("opt-search").value.toLowerCase();
            document.querySelectorAll(".opt-row").forEach(row => {
                const txt = row.querySelector(".opt-name").textContent + row.querySelector(".opt-desc").textContent;
                row.style.display = txt.toLowerCase().includes(filter) ? "flex" : "none";
            });
        };

        window.openAbout = () => document.getElementById("about-modal").style.display = "flex";
        window.closeAbout = () => document.getElementById("about-modal").style.display = "none";


        let ctxMenuTarget = null;
        const ctxMenu = document.getElementById("tab-ctx-menu");

        function showContextMenu(x, y, path) {
            ctxMenuTarget = path;
            ctxMenu.style.display = "block";
            
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const menuW = 160;
            const menuH = 150;
            
            let finalX = x;
            let finalY = y;
            
            if (x + menuW > winW) finalX = winW - menuW - 10;
            if (y + menuH > winH) finalY = winH - menuH - 10;

            ctxMenu.style.left = finalX + "px";
            ctxMenu.style.top = finalY + "px";
        }

        document.addEventListener("click", () => {
            ctxMenu.style.display = "none";
        });

        document.getElementById("ctx-close").addEventListener("click", () => {
            if (ctxMenuTarget) closeTab(ctxMenuTarget);
        });

        document.getElementById("ctx-close-others").addEventListener("click", () => {
            if (!ctxMenuTarget) return;
            const paths = Array.from(openTabs.keys());
            paths.forEach(p => {
                if (p !== ctxMenuTarget) closeTab(p);
            });
            activateTab(ctxMenuTarget);
        });

        document.getElementById("ctx-close-all").addEventListener("click", () => {
            const paths = Array.from(openTabs.keys());
            paths.forEach(p => closeTab(p));
        });

        document.getElementById("ctx-close-right").addEventListener("click", () => {
            if (!ctxMenuTarget) return;
            const paths = Array.from(openTabs.keys());
            const currentIndex = paths.indexOf(ctxMenuTarget);
            if (currentIndex === -1) return;

            const toClose = paths.slice(currentIndex + 1);
            
            toClose.forEach(p => closeTab(p));
            
            activateTab(ctxMenuTarget);
        });

        document.getElementById("ctx-close-left").addEventListener("click", () => {
            if (!ctxMenuTarget) return;
            const paths = Array.from(openTabs.keys());
            const currentIndex = paths.indexOf(ctxMenuTarget);
            if (currentIndex === -1) return;

            const toClose = paths.slice(0, currentIndex);
            
            toClose.forEach(p => closeTab(p));
            
            activateTab(ctxMenuTarget);
        });

    </script>

</body>
</html>